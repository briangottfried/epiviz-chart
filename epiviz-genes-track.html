<!-- Polymer dependency -->
<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../epiviz-imports/epiviz-common-css.html">
<link rel="import" href="../epiviz-imports/epiviz-common-js.html">
<link rel="import" href="../epiviz-imports/epiviz-genes-track-import.html">

<dom-module id="epiviz-genes-track">

    <template>
        <style>
            :host {
                width: '100%';
                display: block;
            }

            /*::shadow .genes-track {}
            ::shadow .genes-track .items { shape-rendering: auto; stroke: #555555; fill-opacity: 0.6; }
            ::shadow .genes-track .exons { stroke: none; }
            ::shadow .genes-track .gene-name { font-weight: bold; font-size: 12; fill: #000000; stroke: none; fill-opacity: 0; }
            ::shadow .genes-track .selected { fill-opacity: 1; stroke: #555555; }
            ::shadow .genes-track .selected .gene-body { stroke: #555555; stroke-width: 3; stroke-opacity: 0.7; }
            ::shadow .genes-track .hovered { fill-opacity: 1; stroke: #555555; }
            ::shadow .genes-track .hovered .gene-body { stroke: #555555; stroke-width: 3; stroke-opacity: 0.7; }
            ::shadow .genes-track .hovered .gene-name { fill-opacity: 1; }
            ::shadow .genes-track .selected .gene-name { fill-opacity: 1; }*/
        </style>

        <!-- local DOM goes here -->
        <!-- <div id="chart" style="min-width:700px"></div> -->
        <content id="chart" style="min-width:700px"> </content>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-genes-track',

            /* Properties that can be defined on the element */
            properties: {
                genome:{
                    type: String,
                    notify: true
                },

                chromosome:{
                    type: String,
                    notify:true
                },

                start:{
                    type: Number,
                    notify:true
                },

                end:{
                    type: Number,
                    notify:true
                },

                useDefaultDataProvider: {
                    type: Boolean,
                    notify: true
                },

                data: {
                    type: Object,
                    notify: true,
                    observer: '_dataChanged'
                },

                configSrc: {
                    type: Object,
                    notify: true,
                    value: function() {

                        epiviz.Config.SETTINGS = {
                            dataProviders: [
                                ["epiviz.data.WebServerDataProvider", "umd", "http://epiviz.cbcb.umd.edu/data/main.php"]
                            ],
                            workspacesDataProvider: sprintf('epiviz.data.EmptyResponseDataProvider', 'empty', ''),
                            useCache: true,

                            chartSettings: {
                                default: {
                                    colors: 'd3-category10',
                                    decorations: [
                                        'epiviz.ui.charts.decoration.RemoveChartButton',
                                        'epiviz.ui.charts.decoration.SaveChartButton',
                                        'epiviz.ui.charts.decoration.CustomSettingsButton',
                                        'epiviz.ui.charts.decoration.EditCodeButton',

                                        'epiviz.ui.charts.decoration.ChartColorsButton',
                                        'epiviz.ui.charts.decoration.ChartLoaderAnimation',
                                        'epiviz.ui.charts.decoration.ChartResize'
                                    ]
                                },

                                plot: {
                                    width: 400,
                                    height: 400,
                                    margins: new epiviz.ui.charts.Margins(15, 30, 30, 15),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                track: {
                                    width: 900,
                                    height: 90,
                                    margins: new epiviz.ui.charts.Margins(25, 20, 23, 10),
                                    decorations: [
                                        'epiviz.ui.charts.decoration.ToggleTooltipButton',

                                        'epiviz.ui.charts.decoration.ChartTooltip',
                                        'epiviz.ui.charts.decoration.ChartFilterCodeButton'
                                    ]
                                },

                                'epiviz.plugins.charts.GenesTrack': {
                                    height: 120,
                                    colors: 'genes-default'
                                },
                            },

                            chartCustomSettings: {
                                'epiviz.plugins.charts.GenesTrack': {

                                },
                            },

                            colorPalettes: [
                                new epiviz.ui.charts.ColorPalette(
                                    ['#025167', '#e7003e', '#ffcd00', '#057d9f', '#970026', '#ffe373', '#ff8100'],
                                    'Epiviz v1.0 Colors', 'epiviz-v1'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Epiviz v2.0 Bright', 'epiviz-v2-bright'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#b8d2eb', '#f2aeac', '#d8e4aa', '#cccccc', '#f2d1b0', '#d4b2d3', '#ddb8a9', '#ebbfd9'],
                                    'Epiviz v2.0 Light', 'epiviz-v2-light'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#599ad3', '#f1595f', '#79c36a', '#727272', '#f9a65a', '#9e66ab', '#cd7058', '#d77fb3'],
                                    'Epiviz v2.0 Medium', 'epiviz-v2-medium'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"],
                                    'D3 Category 10', 'd3-category10'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#1f77b4", "#aec7e8", "#ff7f0e", "#ffbb78", "#2ca02c", "#98df8a", "#d62728", "#ff9896", "#9467bd", "#c5b0d5", "#8c564b", "#c49c94", "#e377c2", "#f7b6d2", "#7f7f7f", "#c7c7c7", "#bcbd22", "#dbdb8d", "#17becf", "#9edae5"],
                                    'D3 Category 20', 'd3-category20'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#393b79", "#5254a3", "#6b6ecf", "#9c9ede", "#637939", "#8ca252", "#b5cf6b", "#cedb9c", "#8c6d31", "#bd9e39", "#e7ba52", "#e7cb94", "#843c39", "#ad494a", "#d6616b", "#e7969c", "#7b4173", "#a55194", "#ce6dbd", "#de9ed6"],
                                    'D3 Category 20b', 'd3-category20b'),
                                new epiviz.ui.charts.ColorPalette(
                                    ["#3182bd", "#6baed6", "#9ecae1", "#c6dbef", "#e6550d", "#fd8d3c", "#fdae6b", "#fdd0a2", "#31a354", "#74c476", "#a1d99b", "#c7e9c0", "#756bb1", "#9e9ac8", "#bcbddc", "#dadaeb", "#636363", "#969696", "#bdbdbd", "#d9d9d9"],
                                    'D3 Category 20c', 'd3-category20c'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#f9a65a', '#599ad3', '#79c36a', '#f1595f', '#727272', '#cd7058', '#d77fb3'],
                                    'Genes Default', 'genes-default'),
                                new epiviz.ui.charts.ColorPalette(
                                    ['#1859a9', '#ed2d2e', '#008c47', '#010101', '#f37d22', '#662c91', '#a11d20', '#b33893'],
                                    'Heatmap Default', 'heatmap-default')
                            ]
                        };

                        return epiviz.Config.SETTINGS;
                    }
                },

                plotId: {
                    type: String,
                    reflectToAttribute: true,
                    notify: true
                        // value: function() {
                        //     var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                        //     var result = '';
                        //     var size = 7;

                    //     for (var i = 0; i < size; ++i) {
                    //         result += chars[Math.round(Math.random() * (chars.length - 1))];
                    //     }
                    //     return 'epiviz-' + result;
                    // }
                },

                measurements: {
                    type: Array,
                    notify: true,
                    observer: '_measurementsChanged'
                        // value: function() {
                        //     return [{
                        //         'id': 'genes',
                        //         'name': 'Genes',
                        //         'type': 'range',
                        //         'datasourceId': 'genes',
                        //         'datasourceGroup': 'genes',
                        //         'dataprovider': 'umd',
                        //         'formula': null,
                        //         'defaultChartType': "Genes Track",
                        //         'annotation': null,
                        //         'minValue': null,
                        //         'maxValue': null,
                        //         'metadata': ['gene', 'entrez', 'exon_starts', 'exon_ends']
                        //     }];
                        // }
                },

                range: {
                    type: Object,
                    notify: true
                        // value: function() {
                        //     return new epiviz.datatypes.GenomicRange("chr11", 82000000, 6000000);
                        // }
                }
            },

            observers: [
                '_dimChanged(dimX.*, dimY.*, dimS.*)'
            ],

            _generatePlotId: function() {
                var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                var result = '';
                var size = 7;

                for (var i = 0; i < size; ++i) {
                    result += chars[Math.round(Math.random() * (chars.length - 1))];
                }
                return 'epiviz-' + result;
            },

            _dimChanged: function() {

                $('#' + this.plotId).empty();
                this.fire('dimChanged', {
                    id: this.plotId
                });
            },

            _measurementsChanged: function() {

                var self = this;

                if (this.measurements != null && self.config != null) {
                    var mSet = new epiviz.measurements.MeasurementSet();

                    for (var i = 0; i < self.measurements.length; i++) {

                        var measurement = self.measurements[i];

                        mSet.add(new epiviz.measurements.Measurement(
                            measurement.id,
                            measurement.name,
                            measurement.type,
                            measurement.datasourceId,
                            measurement.datasourceGroup,
                            measurement.dataprovider,
                            measurement.formula,
                            measurement.defaultChartType,
                            measurement.annotation,
                            measurement.minValue,
                            measurement.maxValue,
                            measurement.metadata
                        ));
                    }

                    self.visConfigSelection = new epiviz.ui.controls.VisConfigSelection(mSet);

                    self.chartType = new epiviz.plugins.charts.GenesTrackType(self.config);

                    self.chartProperties = new epiviz.ui.charts.VisualizationProperties(
                        self.chartType.defaultWidth(),
                        self.chartType.defaultHeight(),
                        self.chartType.defaultMargins(),
                        self.visConfigSelection,
                        self.chartType.defaultColors(),
                        null,
                        self.chartType.customSettingsValues(),
                        self.chartType.customSettingsDefs(), [],
                        null
                    );

                    self.chart = self.chartType.createNew(self.plotId, $('#' + self.plotId), self.chartProperties);

                    // Listen to hover event on the chart
                    self.chart._dispatch.on("hover", function(id, data) {
                        if (data == null) {

                            self.unHover();

                            self.fire('unHover', {
                                id: id
                            });
                        } else {

                            self.hover(data);

                            self.fire('hover', {
                                id: id,
                                data: data
                            });
                        }
                    });
                }
            },

            _dataChanged: function() {
                if (this.data != null && this.chart != null) {
                    this._draw();
                }
            },

            hover: function(data) {
                this.chart.doHover(data);
            },

            unHover: function() {
                this.chart.doUnhover();
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;
                // style observer on charts
                self.scopeSubtree(self.$.chart, true);

                self.plotId = self.plotId || self._generatePlotId();

                var chartContainer = document.createElement('div');
                chartContainer.id = self.plotId;

                Polymer.dom(this.$.chart).appendChild(chartContainer);

                // listen to events 
                var parent = self.parentNode;
                parent.addEventListener('hoverAllCharts', function(e) {
                    self.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.unHover();
                }.bind(self));

                self.config = new epiviz.Config(self.configSrc);

                // var mSet = new epiviz.measurements.MeasurementSet();

                // for (var i = 0; i < self.measurements.length; i++) {

                //     var measurement = self.measurements[i];

                //     mSet.add(new epiviz.measurements.Measurement(
                //         measurement.id,
                //         measurement.name,
                //         measurement.type,
                //         measurement.datasourceId,
                //         measurement.datasourceGroup,
                //         'umd',
                //         null,
                //         null,
                //         null,
                //         measurement.minValue,
                //         measurement.maxValue,
                //         measurement.metadata
                //     ));
                // }

                // self.visConfigSelection = new epiviz.ui.controls.VisConfigSelection(mSet);

                // self.chartType = new epiviz.plugins.charts.GenesTrackType(self.config);

                // self.chartProperties = new epiviz.ui.charts.VisualizationProperties(
                //     self.chartType.defaultWidth(),
                //     self.chartType.defaultHeight(),
                //     self.chartType.defaultMargins(),
                //     self.visConfigSelection,
                //     self.chartType.defaultColors(),
                //     null,
                //     self.chartType.customSettingsValues(),
                //     self.chartType.customSettingsDefs(), [],
                //     null
                // );

                // self.chart = self.chartType.createNew(self.plotId, $('#' + self.plotId), self.chartProperties);

                // TODO: eventually comes from data source for testing only!!
                // FROM HERE
                // var chartMeasMap = {};
                // chartMeasMap[self.plotId] = self.visConfigSelection.measurements;

                // var dataProviderFactory = new epiviz.data.DataProviderFactory(self.config);
                // var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                // dataManager.getData(self.range, chartMeasMap, function(id, data) {
                //     console.log(data);
                //     self.data = data;
                //     self._draw();
                // });
                //TO HERE

                //this._colorsChanged();
                self._measurementsChanged();
                self._dataChanged();

                if (self.useDefaultDataProvider) {

                    self.measurements = self.measurements || [{
                        'id': 'genes',
                        'name': 'Genes',
                        'type': 'range',
                        'datasourceId': 'genes',
                        'datasourceGroup': 'genes',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': "Genes Track",
                        'annotation': null,
                        'minValue': null,
                        'maxValue': null,
                        'metadata': ['gene', 'entrez', 'exon_starts', 'exon_ends']
                    }];

                    self.range = self.range || new epiviz.datatypes.GenomicRange(self.chromosome, self.start, self.end);

                    var numChildren = self.getEffectiveChildren().length;

                    for(var index = 0; index < numChildren; index++){
                        var currChild = self.getContentChildren('#chart')[index];
                        currChild.range = self.range;
                    }

                    self._measurementsChanged();

                    var chartMeasMap = {};
                    chartMeasMap[self.plotId] = self.visConfigSelection.measurements;

                    var dataProviderFactory = new epiviz.data.DataProviderFactory(self.config);
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getData(self.range, chartMeasMap, function(id, data) {
                        self.data = data;
                        //self._draw();
                    });
                }
            },

            _draw: function() {
                this.chart.draw(this.range, this.data);
            }
        });
    </script>
</dom-module>